<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Deploy - Instant URL Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: rgba(255, 255, 255, 0.03);
            --bg-tertiary: rgba(255, 255, 255, 0.06);
            --bg-glass: rgba(255, 255, 255, 0.02);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --accent: #3B82F6;
            --accent-hover: #2563EB;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --success: #10B981;
            --success-glow: rgba(16, 185, 129, 0.5);
            --danger: #EF4444;
            --danger-glow: rgba(239, 68, 68, 0.5);
            --warning: #F59E0B;
            --warning-glow: rgba(245, 158, 11, 0.5);
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            --gradient-3: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Glassmorphism base */
        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass:hover {
            background: var(--bg-secondary);
            border-color: var(--border-hover);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 40px var(--accent-glow);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .logo-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--success-glow);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Navigation */
        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .breadcrumb-item:hover {
            color: var(--text-primary);
        }

        .breadcrumb-separator {
            color: var(--text-tertiary);
            opacity: 0.5;
        }

        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            padding: 2rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--border-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, var(--accent-glow) 0%, transparent 70%);
            opacity: 0.1;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 0.2;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Folders Grid */
        .folders-section {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--border);
            padding: 2rem;
            min-height: 500px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .folder-card {
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .folder-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            transform: translate(-50%, -50%) scale(0);
            opacity: 0.3;
            transition: transform 0.5s ease;
        }

        .folder-card:hover::before {
            transform: translate(-50%, -50%) scale(2);
        }

        .folder-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .folder-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            background: var(--gradient-2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px var(--accent-glow);
            transition: all 0.3s ease;
        }

        .folder-card:hover .folder-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 12px 32px var(--accent-glow);
        }

        .folder-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .folder-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }

        .folder-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .folder-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            border: 1px solid var(--border);
        }

        .folder-badge.protected {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .folder-badge.admin {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #8B5CF6;
        }

        /* Side Panel */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .action-card {
            padding: 2rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .action-card:hover::before {
            opacity: 0.05;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--accent);
        }

        .action-card-icon {
            width: 56px;
            height: 56px;
            background: var(--gradient-2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 24px var(--accent-glow);
        }

        .action-card-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
        }

        .action-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Projects Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-2);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .project-card:hover::before {
            transform: translateX(0);
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .project-card.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-url {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .project-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            background: var(--bg-tertiary);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .project-status.blank {
            background: rgba(156, 163, 175, 0.1);
            border-color: rgba(156, 163, 175, 0.3);
            color: #9CA3AF;
        }

        .project-status.active {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .project-url-full {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .project-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
        }

        .btn:hover::before {
            transform: translate(-50%, -50%) scale(2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        /* Quick Deploy */
        .quick-deploy {
            padding: 2.5rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .quick-deploy::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            opacity: 0.1;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .quick-deploy h3 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        .quick-deploy p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .deploy-btn {
            padding: 1rem 3rem;
            font-size: 1.125rem;
            background: var(--gradient-2);
            box-shadow: 0 8px 24px var(--accent-glow);
            position: relative;
            z-index: 1;
        }

        .deploy-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px var(--accent-glow);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .modal-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* Inputs */
        .input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .input::placeholder {
            color: var(--text-tertiary);
        }

        /* Checkbox */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            max-width: 400px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
        }

        .toast.warning {
            border-color: rgba(245, 158, 11, 0.3);
            background: rgba(245, 158, 11, 0.1);
        }

        /* Loading */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Auth Section */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card {
            max-width: 500px;
            width: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 3rem;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3);
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            background: var(--gradient-2);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 32px var(--accent-glow);
            animation: float 6s ease-in-out infinite;
        }

        .auth-logo svg {
            width: 40px;
            height: 40px;
            color: white;
        }

        .auth-card h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .auth-card p {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin-bottom: 2.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            opacity: 0.2;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
            max-width: 400px;
            margin-bottom: 0;
        }

        /* Empty State Button Fix */
        .empty-state .btn {
            padding: 0.875rem 2rem !important;
            font-size: 1rem !important;
            background: var(--gradient-2) !important;
            color: white !important;
            border: none !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            position: relative !important;
            overflow: hidden !important;
            white-space: nowrap !important;
            margin-top: 1.5rem !important;
            box-shadow: 0 4px 16px var(--accent-glow) !important;
            width: auto !important;
            height: auto !important;
            min-width: auto !important;
            max-width: none !important;
        }

        .empty-state .btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 24px var(--accent-glow) !important;
        }

        .empty-state .btn svg {
            width: 16px !important;
            height: 16px !important;
            opacity: 1 !important;
            margin: 0 !important;
        }

        /* Template Selector */
        .template-selector {
            margin-top: 2rem;
            padding: 2rem;
            background: var(--bg-tertiary);
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            z-index: 10;
        }

        .action-card.no-hover {
            cursor: default;
        }

        .action-card.no-hover:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--border);
        }

        .action-card.no-hover:hover::before {
            opacity: 0;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            position: relative;
            z-index: 20;
        }

        .template-option {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            z-index: 30;
            pointer-events: auto !important;
        }

        .template-option * {
            pointer-events: none;
        }

        .template-option:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .template-option.selected {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .template-option svg {
            width: 40px;
            height: 40px;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }

        /* Team badge */
        .team-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.875rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #8B5CF6;
            margin-left: 1rem;
        }

        /* IMPROVED: Management Cards with better layout */
        .management-card {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 250px;
        }

        .management-card.hidden {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.01);
        }

        .management-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .management-card-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .management-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem 0;
        }

        .management-card-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        .management-card-icon svg {
            width: 30px;
            height: 30px;
            color: white;
        }

        .management-card-name {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .management-card-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .management-card-actions {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* Visibility Toggle Button */
        .visibility-toggle {
            width: 40px;
            height: 40px;
            padding: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .visibility-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .visibility-toggle.visible {
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .visibility-toggle.hidden {
            color: var(--danger);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .visibility-toggle svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        /* Management Grid Layout */
        .management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        /* Newest badge */
        .newest-badge {
            position: absolute;
            top: -8px;
            right: 1rem;
            background: var(--gradient-2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 4px 12px var(--accent-glow);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .main-grid {
                grid-template-columns: 1fr;
            }

            .folders-grid,
            .projects-grid,
            .management-grid {
                grid-template-columns: 1fr;
            }

            .nav-breadcrumb {
                padding: 0.75rem 1rem;
            }

            .quick-deploy {
                padding: 2rem;
            }

            .deploy-btn {
                padding: 0.875rem 2rem;
                font-size: 1rem;
            }
        }

        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }

        /* Additional premium effects */
        .glow-text {
            text-shadow: 0 0 20px var(--accent-glow);
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div class="auth-container" id="authSection">
        <div class="auth-card">
            <div class="auth-logo">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 22.525H0l12-21.05 12 21.05z"/>
                </svg>
            </div>
            <h2>Vercel Deploy</h2>
            <p>Transform any page with one click</p>
            <input type="password" class="input" id="vercelToken" placeholder="Enter your Vercel access token">
            <button class="btn deploy-btn" onclick="saveToken()" style="width: 100%;">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Connect & Deploy
            </button>
            <p style="margin-top: 1.5rem; font-size: 0.875rem; color: var(--text-tertiary);">
                Get your token from <a href="https://vercel.com/account/tokens" target="_blank" style="color: var(--accent); text-decoration: none;">vercel.com/account/tokens</a>
            </p>
            <details style="margin-top: 1rem;">
                <summary style="font-size: 0.875rem; color: var(--text-tertiary); cursor: pointer;">Having trouble with data sync?</summary>
                <div style="margin-top: 0.5rem; font-size: 0.8125rem; color: var(--text-tertiary);">
                    <p>If your folders are missing (e.g., in private mode), you can manually set your data project:</p>
                    <input type="text" class="input" id="dataProjectOverride" placeholder="verceldeploy-data-xxxxx" style="margin-top: 0.5rem;">
                    <button class="btn btn-secondary" onclick="overrideDataProject()" style="margin-top: 0.5rem;">Use This Data Project</button>
                </div>
            </details>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" style="display: none;">
        <div class="auth-container">
            <div class="auth-card">
                <div class="spinner" style="width: 60px; height: 60px; margin: 0 auto 2rem;"></div>
                <h3>Initializing Vercel Deploy</h3>
                <p style="color: var(--text-secondary);">Syncing with Vercel...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M24 22.525H0l12-21.05 12 21.05z"/>
                        </svg>
                    </div>
                    <h1>Vercel Deploy</h1>
                </div>
                <div class="header-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="connectionStatus">Connected to Vercel</span>
                    <span class="team-badge" id="teamBadge" style="display: none;">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span id="teamName">Team</span>
                    </span>
                    <span id="dataProjectInfo" style="display: none; font-size: 0.75rem; color: var(--text-tertiary); margin-left: 1rem;">
                        Data: <code id="dataProjectName" style="background: var(--bg-tertiary); padding: 0.125rem 0.375rem; border-radius: 4px;"></code>
                    </span>
                </div>
            </header>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalProjects">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activePages">0</div>
                    <div class="stat-label">Active Pages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="blankPages">0</div>
                    <div class="stat-label">Blank Pages</div>
                </div>
            </div>

            <!-- Folders View -->
            <div id="foldersView">
                <div class="main-grid">
                    <div class="folders-section">
                        <div class="section-header">
                            <h2 class="section-title">Project Folders</h2>
                        </div>
                        <div class="folders-grid" id="foldersGrid">
                            <!-- Folders will be dynamically generated -->
                        </div>
                    </div>

                    <div class="side-panel">
                        <div class="action-card" onclick="attemptManageFolders()">
                            <div class="folder-badge admin" style="position: absolute; top: 1rem; right: 1rem;">🔒 Admin</div>
                            <div class="action-card-icon">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <h3>Manage Folders</h3>
                            <p>Organize projects with secure, password-protected folders.</p>
                        </div>

                        <div class="action-card" onclick="attemptOpenOffers()">
                            <div class="folder-badge admin" style="position: absolute; top: 1rem; right: 1rem;">🔒 Admin</div>
                            <div class="action-card-icon">
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M7 7h10l2 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2zM7 3h10a2 2 0 012 2v2H5V5a2 2 0 012-2z"/>
                                </svg>
                            </div>
                            <h3>Offer Templates</h3>
                            <p>Pre-built pages ready to deploy with one click.</p>
                        </div>

                        <div class="action-card" style="background: var(--bg-tertiary); cursor: default;">
                            <h4 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary);">Quick Stats</h4>
                            <div style="display: grid; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Total Folders</span>
                                    <span style="font-weight: 600; color: var(--accent);" id="totalFoldersCount">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Protected</span>
                                    <span style="font-weight: 600; color: var(--warning);" id="protectedFoldersCount">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Templates</span>
                                    <span style="font-weight: 600; color: var(--success);" id="offersCount">0</span>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <p style="font-size: 0.75rem; color: var(--text-tertiary); line-height: 1.4;">
                                    💡 <strong>Tip:</strong> Data is stored in a Vercel project. Check the header for your data project name if you need to recover it.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Folder Content View -->
            <div id="folderContentView" style="display: none;">
                <nav class="nav-breadcrumb">
                    <button class="btn btn-icon btn-secondary" onclick="showFoldersView()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <a href="#" class="breadcrumb-item" onclick="showFoldersView(); return false;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a2 2 0 002 2h10a2 2 0 002-2V10"/>
                        </svg>
                        Folders
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current" id="currentFolder"></span>
                </nav>

                <div class="main-grid">
                    <div class="folders-section">
                        <div class="section-header">
                            <h2 class="section-title" id="folderTitle">Projects</h2>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-secondary" onclick="refreshFromVercel()" id="refreshBtn" title="Refresh projects from Vercel">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    Refresh
                                </button>
                                <button class="btn btn-danger" onclick="bulkDeleteFolder()" id="bulkDeleteBtn">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                    Delete All
                                </button>
                            </div>
                        </div>
                        
                        <div class="projects-grid" id="projectsGrid">
                            <!-- Projects will be dynamically generated -->
                        </div>
                    </div>

                    <div class="side-panel">
                        <div class="quick-deploy">
                            <h3>One-Click Deploy</h3>
                            <p>Transform any page instantly</p>
                            <button class="btn deploy-btn" onclick="quickDeploy()">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                Deploy Now
                            </button>
                        </div>

                        <div id="selectedProjectEditor" style="display: none;" class="action-card no-hover">
                            <h4 style="margin-bottom: 1.5rem;">Editing: <span id="editingProjectName" style="color: var(--accent);"></span></h4>
                            
                            <div class="template-selector" id="templateSelector">
                                <!-- Template options will be inserted here -->
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button class="btn" onclick="updateProject()" style="flex: 1;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                    </svg>
                                    Deploy
                                </button>
                                <button class="btn btn-danger btn-icon" onclick="deleteProject()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Folder Management View -->
            <div id="folderManagementView" style="display: none;">
                <nav class="nav-breadcrumb">
                    <button class="btn btn-icon btn-secondary" onclick="showFoldersView()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M15 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <a href="#" class="breadcrumb-item" onclick="showFoldersView()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a2 2 0 002 2h10a2 2 0 002-2V10"/>
                        </svg>
                        Folders
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">Manage Folders</span>
                </nav>

                <div class="folders-section">
                    <div class="section-header">
                        <h2 class="section-title">Folder Management</h2>
                        <button class="btn" onclick="createNewFolder()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 4v16m8-8H4"/>
                            </svg>
                            New Folder
                        </button>
                    </div>
                    
                    <div id="foldersList" style="padding: 1.5rem;">
                        <!-- Folders list will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Password/Admin Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Enter Password</h3>
            <p class="modal-description" id="modalDescription">Enter password to continue.</p>
            <input type="password" class="input" id="passwordInput" placeholder="Enter password">
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn" onclick="checkPassword()" style="flex: 1;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    Unlock
                </button>
                <button class="btn btn-secondary" onclick="closeModal('passwordModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Folder Modal -->
    <div class="modal" id="folderModal">
        <div class="modal-content">
            <h3 class="modal-title" id="folderModalTitle">Create New Folder</h3>
            <p class="modal-description">Create secure folders for your team.</p>
            <input type="text" class="input" id="folderNameInput" placeholder="Folder name">
            <label class="checkbox-wrapper">
                <input type="checkbox" class="checkbox" id="folderProtected">
                <span>Password protect this folder</span>
            </label>
            <input type="password" class="input" id="folderPasswordInput" placeholder="Password (if protected)" style="display: none;">
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn" onclick="saveFolderSettings()" style="flex: 1;">Save Folder</button>
                <button class="btn btn-secondary" onclick="closeModal('folderModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Offer Modal -->
    <div class="modal" id="offerModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="modal-title" id="offerModalTitle">Create Offer Template</h3>
            <p class="modal-description">Save your page as a reusable template.</p>
            <input type="text" class="input" id="offerName" placeholder="Template name">
            <textarea class="input" id="offerHtml" placeholder="Paste your HTML code here..." style="min-height: 300px; font-family: 'SF Mono', Monaco, monospace; font-size: 0.875rem;"></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn" onclick="saveOffer()" style="flex: 1;">Save Template</button>
                <button class="btn btn-secondary" onclick="closeModal('offerModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Deploy Name Modal -->
    <div class="modal" id="deployModal">
        <div class="modal-content">
            <h3 class="modal-title">Deploy New Project</h3>
            <p class="modal-description">Choose a name for your project or use a random one.</p>
            <input type="text" class="input" id="deployNameInput" placeholder="Project name (e.g., my-app)">
            <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">Leave empty for random name. Only lowercase letters, numbers, and hyphens allowed.</p>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn" onclick="confirmDeploy()" style="flex: 1;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Deploy
                </button>
                <button class="btn btn-secondary" onclick="closeModal('deployModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg id="toastIcon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // Constants
        const DATA_VERSION = '1.0.0';
        
        // State
        let state = {
            vercelToken: localStorage.getItem('vercelToken') || '',
            teamId: localStorage.getItem('vercelTeamId') || '',
            teamName: localStorage.getItem('vercelTeamName') || '',
            dataProjectName: localStorage.getItem('userDataProjectName') || '',
            dataProjectUrl: localStorage.getItem('userDataProjectUrl') || '',
            projects: [],
            selectedProject: null,
            selectedTemplate: 'blank',
            selectedOffer: null,
            folders: [],
            currentFolder: null,
            offers: [],
            adminPassword: '1511',
            pendingAction: null,
            editingFolderIndex: null,
            editingOfferIndex: null
        };

        // Event listeners cleanup tracking
        let modalClickListeners = [];

        // Generate unique data project name for this user
        async function getDataProjectName() {
            if (!state.dataProjectName) {
                // First check localStorage
                state.dataProjectName = localStorage.getItem('userDataProjectName');
                
                if (!state.dataProjectName) {
                    // Generate a deterministic name based on the user/team
                    // This ensures the same data project is used even in private mode
                    
                    try {
                        // Get user info to create a deterministic project name
                        const userResponse = await fetch('https://api.vercel.com/v2/user', {
                            headers: { 'Authorization': `Bearer ${state.vercelToken}` }
                        });
                        
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            
                            // Use user ID or username to create deterministic name
                            const userId = userData.user.id || userData.user.username || userData.user.email;
                            
                            // Create a simple hash from the user ID
                            let hash = 0;
                            for (let i = 0; i < userId.length; i++) {
                                hash = ((hash << 5) - hash) + userId.charCodeAt(i);
                                hash = hash & hash; // Convert to 32-bit integer
                            }
                            
                            // Convert to positive number and base36
                            const userHash = Math.abs(hash).toString(36);
                            
                            // Create deterministic project name
                            state.dataProjectName = `verceldeploy-data-${userHash}`;
                            
                            console.log('Generated deterministic data project name:', state.dataProjectName);
                        } else {
                            // Fallback to random if can't get user info
                            state.dataProjectName = `verceldeploy-data-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                            console.log('Using random data project name (fallback):', state.dataProjectName);
                        }
                    } catch (error) {
                        console.error('Error getting user info for data project name:', error);
                        // Fallback to random
                        state.dataProjectName = `verceldeploy-data-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    }
                    
                    // Save to localStorage for this session
                    localStorage.setItem('userDataProjectName', state.dataProjectName);
                }
            }
            
            return state.dataProjectName;
        }

        // Get team query parameter for API calls
        function getTeamQuery() {
            return state.teamId ? `?teamId=${state.teamId}` : '';
        }

        // Detect team from token
        async function detectTeam() {
            try {
                console.log('Detecting team configuration...');
                
                // First, try the teams endpoint to list teams
                const teamsResponse = await fetch('https://api.vercel.com/v2/teams', {
                    headers: { 'Authorization': `Bearer ${state.vercelToken}` }
                });
                
                if (teamsResponse.ok) {
                    const teamsData = await teamsResponse.json();
                    console.log('Teams response:', teamsData);
                    
                    if (teamsData.teams && teamsData.teams.length > 0) {
                        // Use the first team (or the one matching the token scope)
                        const team = teamsData.teams[0];
                        state.teamId = team.id;
                        state.teamName = team.name;
                        localStorage.setItem('vercelTeamId', state.teamId);
                        localStorage.setItem('vercelTeamName', state.teamName);
                        
                        console.log('Using team:', state.teamName, '(', state.teamId, ')');
                        
                        // Show team badge
                        document.getElementById('teamBadge').style.display = 'inline-flex';
                        document.getElementById('teamName').textContent = state.teamName;
                        
                        return true;
                    }
                }
                
                // If no teams or teams endpoint failed, try user endpoint
                const userResponse = await fetch('https://api.vercel.com/v2/user', {
                    headers: { 'Authorization': `Bearer ${state.vercelToken}` }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    console.log('User data:', userData);
                    
                    // Check if there's team info in user data
                    if (userData.team) {
                        state.teamId = userData.team.id;
                        state.teamName = userData.team.name || 'Team';
                        localStorage.setItem('vercelTeamId', state.teamId);
                        localStorage.setItem('vercelTeamName', state.teamName);
                        
                        console.log('Using team from user data:', state.teamName, '(', state.teamId, ')');
                        
                        // Show team badge
                        document.getElementById('teamBadge').style.display = 'inline-flex';
                        document.getElementById('teamName').textContent = state.teamName;
                        
                        return true;
                    }
                }
                
                // No team found - personal account
                console.log('No team detected - using personal account');
                state.teamId = '';
                state.teamName = '';
                localStorage.removeItem('vercelTeamId');
                localStorage.removeItem('vercelTeamName');
                document.getElementById('teamBadge').style.display = 'none';
                
                return false;
            } catch (error) {
                console.error('Error detecting team:', error);
                
                // If there's a cached team ID, try using it
                const cachedTeamId = localStorage.getItem('vercelTeamId');
                if (cachedTeamId) {
                    state.teamId = cachedTeamId;
                    state.teamName = localStorage.getItem('vercelTeamName') || 'Team';
                    document.getElementById('teamBadge').style.display = 'inline-flex';
                    document.getElementById('teamName').textContent = state.teamName;
                    console.log('Using cached team:', state.teamName, '(', state.teamId, ')');
                    return true;
                }
                
                return false;
            }
        }

        // Load cached data from localStorage
        function loadCachedData() {
            try {
                const cached = localStorage.getItem('vercelDeployData');
                if (cached) {
                    const data = JSON.parse(cached);
                    
                    // Validate data structure
                    if (data && typeof data === 'object') {
                        state.projects = Array.isArray(data.projects) ? data.projects : [];
                        state.folders = Array.isArray(data.folders) ? data.folders : [];
                        state.offers = Array.isArray(data.offers) ? data.offers : [];
                        
                        // Ensure Offers folder exists
                        if (!state.folders.find(f => f.name === 'Offers')) {
                            state.folders.unshift({ name: 'Offers', special: true, icon: 'offers' });
                        }
                        
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error loading cached data:', error);
                localStorage.removeItem('vercelDeployData');
            }
            return false;
        }

        // Save data to localStorage
        function saveCachedData() {
            try {
                const dataToCache = {
                    projects: state.projects,
                    folders: state.folders,
                    offers: state.offers,
                    version: DATA_VERSION,
                    timestamp: Date.now()
                };
                localStorage.setItem('vercelDeployData', JSON.stringify(dataToCache));
            } catch (error) {
                console.error('Error saving cached data:', error);
                if (error.name === 'QuotaExceededError') {
                    showToast('Storage full - clearing old data', 'warning');
                    localStorage.removeItem('vercelDeployData');
                }
            }
        }

        // Initialize
        async function init() {
            if (state.vercelToken) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('loadingState').style.display = 'block';
                
                // Load cached team info if available
                state.teamId = localStorage.getItem('vercelTeamId') || '';
                state.teamName = localStorage.getItem('vercelTeamName') || '';
                
                // Detect team first
                await detectTeam();
                
                // First, load cached data immediately
                const hasCachedData = loadCachedData();
                
                // Then ensure data project exists
                const dataReady = await ensureDataProject();
                if (dataReady) {
                    // Show data project info
                    if (state.dataProjectName) {
                        document.getElementById('dataProjectInfo').style.display = 'inline';
                        document.getElementById('dataProjectName').textContent = state.dataProjectName;
                    }
                    
                    // Try to load fresh data from Vercel
                    const freshDataLoaded = await loadUserData();
                    
                    // Ensure we always have basic structure
                    if (!state.folders.find(f => f.name === 'Offers')) {
                        state.folders.unshift({ name: 'Offers', special: true, icon: 'offers' });
                        saveCachedData();
                    }
                }
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                showFoldersView();
                updateStats();
            }
        }

        // Vercel Data Management
        async function ensureDataProject() {
            try {
                const projectName = await getDataProjectName();
                
                // Check if project exists
                console.log('Checking for data project:', projectName);
                const response = await fetch(`https://api.vercel.com/v9/projects/${projectName}${getTeamQuery()}`, {
                    headers: { 'Authorization': `Bearer ${state.vercelToken}` }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('Data project not found, creating...');
                        // Create the project
                        const createBody = {
                            name: projectName
                        };
                        
                        const createResponse = await fetch(`https://api.vercel.com/v9/projects${getTeamQuery()}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${state.vercelToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(createBody)
                        });
                        
                        if (!createResponse.ok) {
                            const errorData = await createResponse.text();
                            console.error('Failed to create project:', errorData);
                            
                            // Parse error for more specific message
                            let errorMessage = 'Failed to create data project';
                            try {
                                const errorJson = JSON.parse(errorData);
                                if (errorJson.error && errorJson.error.message) {
                                    errorMessage = errorJson.error.message;
                                }
                            } catch (e) {
                                // Use generic message
                            }
                            
                            throw new Error(errorMessage);
                        }
                        
                        const projectData = await createResponse.json();
                        console.log('Data project created successfully:', projectData.name);
                        
                        // Store the project URL
                        state.dataProjectUrl = `https://${projectName}.vercel.app`;
                        localStorage.setItem('userDataProjectUrl', state.dataProjectUrl);
                        
                        // Check if we have cached data to restore
                        const cachedData = localStorage.getItem('vercelDeployData');
                        if (cachedData) {
                            const data = JSON.parse(cachedData);
                            await saveUserData(data);
                        } else {
                            // Create initial data structure
                            await saveUserData({
                                projects: [],
                                folders: [{ name: 'Offers', special: true, icon: 'offers' }],
                                offers: []
                            });
                        }
                    } else {
                        // Other error
                        const errorText = await response.text();
                        console.error('Error checking project:', errorText);
                        throw new Error(`Failed to access project: ${response.status}`);
                    }
                } else {
                    console.log('Data project exists');
                    // Project exists, ensure we have the URL
                    if (!state.dataProjectUrl) {
                        state.dataProjectUrl = `https://${projectName}.vercel.app`;
                        localStorage.setItem('userDataProjectUrl', state.dataProjectUrl);
                    }
                }
                return true;
            } catch (error) {
                console.error('Error ensuring data project:', error);
                showToast(`Storage error: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadUserData() {
            try {
                const projectName = await getDataProjectName();
                const dataUrl = state.dataProjectUrl || `https://${projectName}.vercel.app`;
                
                // Try with a longer delay for deployment to be ready
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const response = await fetch(`${dataUrl}/data.json?t=${Date.now()}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Validate data
                    if (data && typeof data === 'object') {
                        state.projects = Array.isArray(data.projects) ? data.projects : [];
                        state.folders = Array.isArray(data.folders) ? data.folders : [{ name: 'Offers', special: true, icon: 'offers' }];
                        state.offers = Array.isArray(data.offers) ? data.offers : [];
                        
                        // Preserve actualUrl for all projects and clean them
                        state.projects.forEach(project => {
                            if (!project.actualUrl && project.url) {
                                project.actualUrl = cleanUrl(project.url);
                            } else if (project.actualUrl) {
                                project.actualUrl = cleanUrl(project.actualUrl);
                            }
                            if (project.url) {
                                project.url = cleanUrl(project.url);
                            }
                        });
                        
                        // Update cache with fresh data
                        saveCachedData();
                        
                        return true;
                    }
                } else if (response.status === 404 || response.status === 0) {
                    // 404 or CORS error - deployment might not be ready yet
                    // Use cached data if available
                    const cachedData = localStorage.getItem('vercelDeployData');
                    if (cachedData) {
                        console.log('Using cached data while deployment is processing');
                        return false; // Already loaded from cache
                    } else {
                        // Create new default data
                        const defaultData = {
                            projects: [],
                            folders: [{ name: 'Offers', special: true, icon: 'offers' }],
                            offers: []
                        };
                        await saveUserData(defaultData);
                        Object.assign(state, defaultData);
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error loading user data:', error);
                // If it's a network error (CORS), treat it like a 404
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    const cachedData = localStorage.getItem('vercelDeployData');
                    if (cachedData) {
                        console.log('Using cached data due to network error');
                        return false;
                    }
                }
                return false;
            }
        }

        async function saveUserData(data = null) {
            try {
                const projectName = await getDataProjectName();
                const dataToSave = data || {
                    projects: state.projects,
                    folders: state.folders,
                    offers: state.offers,
                    version: DATA_VERSION
                };
                
                // Save to cache immediately
                saveCachedData();
                
                console.log('Deploying data to Vercel...');
                
                // Simplified deployment data - only static JSON file
                const deploymentData = {
                    name: projectName,
                    files: [{
                        file: 'data.json',
                        data: JSON.stringify(dataToSave, null, 2)
                    }],
                    target: 'production',
                    public: true
                };
                
                const response = await fetch(`https://api.vercel.com/v13/deployments${getTeamQuery()}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.vercelToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deploymentData)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Deployment error response:', errorData);
                    
                    // Parse error for more specific message
                    let errorMessage = 'Failed to deploy data';
                    try {
                        const errorJson = JSON.parse(errorData);
                        if (errorJson.error && errorJson.error.message) {
                            errorMessage = errorJson.error.message;
                        }
                    } catch (e) {
                        // Use generic message
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const deploymentResult = await response.json();
                console.log('Data deployed successfully:', deploymentResult.id);
                
                // Don't wait for deployment to be ready - it happens in background
                return true;
            } catch (error) {
                console.error('Error saving user data:', error);
                // Even if deploy fails, we have local cache
                showToast('Data saved locally, sync may be delayed', 'warning');
                return false;
            }
        }

        // Auth
        async function saveToken() {
            const token = document.getElementById('vercelToken').value;
            
            if (!token) {
                showToast('Please enter your Vercel token', 'error');
                return;
            }
            
            // Check if token changed
            const tokenChanged = state.vercelToken !== token;
            
            state.vercelToken = token;
            localStorage.setItem('vercelToken', token);
            
            // Clear cache and data project info if token changed (different account)
            if (tokenChanged) {
                localStorage.removeItem('vercelDeployData');
                localStorage.removeItem('userDataProjectName');
                localStorage.removeItem('userDataProjectUrl');
                localStorage.removeItem('vercelTeamId');
                localStorage.removeItem('vercelTeamName');
                state.projects = [];
                state.folders = [];
                state.offers = [];
                state.dataProjectName = '';
                state.dataProjectUrl = '';
                state.teamId = '';
                state.teamName = '';
            }
            
            showToast('Connecting to Vercel...', 'success');
            await init();
        }

        // UI Updates
        function updateStats() {
            const totalProjects = state.projects.length;
            const activePages = state.projects.filter(p => p.template && p.template !== 'blank').length;
            const blankPages = state.projects.filter(p => !p.template || p.template === 'blank').length;
            
            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('activePages').textContent = activePages;
            document.getElementById('blankPages').textContent = blankPages;
        }

        // Views
        function showFoldersView() {
            // Hide all views
            document.getElementById('folderContentView').style.display = 'none';
            document.getElementById('folderManagementView').style.display = 'none';
            // Show folders view
            document.getElementById('foldersView').style.display = 'block';
            
            state.currentFolder = null;
            
            // Ensure Offers folder always exists
            if (!state.folders.find(f => f.name === 'Offers')) {
                state.folders.unshift({ name: 'Offers', special: true, icon: 'offers', available: true });
                saveCachedData();
            }
            
            // Filter folders based on availability (only show available folders to non-admins)
            const allFolders = state.folders.filter(f => f.name !== 'Offers');
            const availableFolders = allFolders.filter(f => f.available !== false);
            const protectedFolders = availableFolders.filter(f => f.protected);
            
            // Update quick stats
            document.getElementById('totalFoldersCount').textContent = availableFolders.length;
            document.getElementById('protectedFoldersCount').textContent = protectedFolders.length;
            document.getElementById('offersCount').textContent = state.offers.filter(o => o.available !== false).length;
            
            // Generate folders (only show available ones)
            const foldersGrid = document.getElementById('foldersGrid');
            const unassignedProjects = state.projects.filter(p => !p.folder);
            const foldersToShow = [...availableFolders];
            
            if (unassignedProjects.length > 0) {
                foldersToShow.push({ name: 'Unassigned', protected: false, special: true, available: true });
            }
            
            foldersGrid.innerHTML = foldersToShow.map(folder => {
                const folderProjects = folder.name === 'Unassigned' 
                    ? unassignedProjects
                    : state.projects.filter(p => p.folder === folder.name);
                
                return `
                <div class="folder-card" onclick="openFolder('${folder.name}', false)">
                    ${folder.protected ? '<div class="folder-badge protected">🔒 Protected</div>' : ''}
                    <div class="folder-icon">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                    </div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count">${folderProjects.length} project${folderProjects.length !== 1 ? 's' : ''}</div>
                </div>`;
            }).join('');
            
            // Hide selected project editor when going back to folders
            document.getElementById('selectedProjectEditor').style.display = 'none';
            state.selectedProject = null;
        }

        // Admin Actions
        function attemptManageFolders() {
            state.pendingAction = { type: 'manageFolders' };
            showAdminPrompt();
        }

        function attemptOpenOffers() {
            state.pendingAction = { type: 'openOffers' };
            showAdminPrompt();
        }

        function showAdminPrompt() {
            const actionText = state.pendingAction?.type === 'manageFolders' 
                ? 'manage folders' 
                : 'access offer templates';
            
            document.getElementById('modalTitle').textContent = 'Admin Access Required';
            document.getElementById('modalDescription').textContent = `Enter the admin password to ${actionText}.`;
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').classList.add('show');
            document.getElementById('passwordInput').focus();
        }

        // Password Check
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            
            if (state.pendingAction?.type === 'openFolder') {
                // Regular folder password
                const folder = state.folders.find(f => f.name === state.pendingAction.folderName);
                if (folder && password === folder.password) {
                    const folderName = state.pendingAction.folderName;
                    closeModal('passwordModal');
                    state.pendingAction = null;
                    openFolder(folderName);
                    showToast('Folder unlocked', 'success');
                } else {
                    showToast('Incorrect password', 'error');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            } else {
                // Admin password
                if (password === state.adminPassword) {
                    const actionType = state.pendingAction?.type;
                    closeModal('passwordModal');
                    state.pendingAction = null;
                    
                    if (actionType === 'manageFolders') {
                        showFolderManagement();
                        showToast('Access granted', 'success');
                    } else if (actionType === 'openOffers') {
                        openFolder('Offers', true);  // Pass authenticated = true
                        showToast('Access granted', 'success');
                    }
                } else {
                    showToast('Incorrect admin password', 'error');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            }
        }

        // Folder Management
        function showFolderManagement() {
            // Hide all other views first
            document.getElementById('foldersView').style.display = 'none';
            document.getElementById('folderContentView').style.display = 'none';
            // Show management view
            document.getElementById('folderManagementView').style.display = 'block';
            
            const foldersList = document.getElementById('foldersList');
            const allFolders = state.folders.filter(f => f.name !== 'Offers');
            
            if (allFolders.length === 0) {
                foldersList.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <h3>No Folders Yet</h3>
                        <p>Create your first folder to organize projects</p>
                    </div>`;
            } else {
                foldersList.innerHTML = `
                    <div class="management-grid">
                        ${allFolders.map((folder, idx) => {
                            const actualIndex = state.folders.findIndex(f => f.name === folder.name);
                            const projectCount = state.projects.filter(p => p.folder === folder.name).length;
                            const isAvailable = folder.available !== false;
                            
                            return `
                            <div class="management-card ${!isAvailable ? 'hidden' : ''}">
                                <div class="management-card-header">
                                    <div>
                                        <div class="management-card-badges">
                                            ${folder.protected ? '<div class="folder-badge protected">🔒 Protected</div>' : ''}
                                            ${!isAvailable ? '<div class="folder-badge" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger);">Hidden</div>' : ''}
                                        </div>
                                    </div>
                                    <button class="visibility-toggle ${isAvailable ? 'visible' : 'hidden'}" onclick="event.stopPropagation(); toggleFolderAvailability(${actualIndex})" title="${isAvailable ? 'Hide folder' : 'Show folder'}">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${isAvailable ? 
                                                '<path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>' :
                                                '<path d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>'
                                            }
                                        </svg>
                                    </button>
                                </div>
                                <div class="management-card-content">
                                    <div class="management-card-icon">
                                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                        </svg>
                                    </div>
                                    <div class="management-card-name">${folder.name}</div>
                                    <div class="management-card-count">${projectCount} project${projectCount !== 1 ? 's' : ''}</div>
                                </div>
                                <div class="management-card-actions">
                                    <button class="btn btn-icon btn-secondary" onclick="event.stopPropagation(); editFolder(${actualIndex})">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button class="btn btn-icon btn-danger" onclick="event.stopPropagation(); deleteFolder(${actualIndex})">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>`;
            }
        }

        function createNewFolder() {
            state.editingFolderIndex = null;
            document.getElementById('folderModalTitle').textContent = 'Create New Folder';
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderProtected').checked = false;
            document.getElementById('folderPasswordInput').value = '';
            document.getElementById('folderPasswordInput').style.display = 'none';
            document.getElementById('folderModal').classList.add('show');
            document.getElementById('folderNameInput').focus();
        }

        function editFolder(index) {
            const folder = state.folders[index];
            state.editingFolderIndex = index;
            
            document.getElementById('folderModalTitle').textContent = 'Edit Folder';
            document.getElementById('folderNameInput').value = folder.name;
            document.getElementById('folderProtected').checked = folder.protected;
            document.getElementById('folderPasswordInput').value = '';
            document.getElementById('folderPasswordInput').style.display = folder.protected ? 'block' : 'none';
            document.getElementById('folderModal').classList.add('show');
            document.getElementById('folderNameInput').focus();
        }

        async function saveFolderSettings() {
            const name = document.getElementById('folderNameInput').value.trim();
            const isProtected = document.getElementById('folderProtected').checked;
            const password = isProtected ? document.getElementById('folderPasswordInput').value : null;
            
            if (!name) {
                showToast('Please enter a folder name', 'error');
                return;
            }
            
            if (isProtected && !password) {
                showToast('Please enter a password', 'error');
                return;
            }
            
            const folderData = { 
                name, 
                protected: isProtected, 
                password,
                available: true // New folders are available by default
            };
            
            if (state.editingFolderIndex !== null) {
                const oldName = state.folders[state.editingFolderIndex].name;
                // Preserve the availability status when editing
                folderData.available = state.folders[state.editingFolderIndex].available !== false;
                state.folders[state.editingFolderIndex] = folderData;
                
                if (oldName !== name) {
                    state.projects.forEach(project => {
                        if (project.folder === oldName) project.folder = name;
                    });
                }
            } else {
                state.folders.push(folderData);
            }
            
            saveCachedData();
            await saveUserData();
            showToast(state.editingFolderIndex !== null ? 'Folder updated!' : 'Folder created!', 'success');
            closeModal('folderModal');
            showFolderManagement();
        }

        async function toggleFolderAvailability(index) {
            const folder = state.folders[index];
            folder.available = folder.available === false ? true : false;
            
            saveCachedData();
            await saveUserData();
            showToast(folder.available ? 'Folder is now visible' : 'Folder is now hidden', 'success');
            showFolderManagement();
        }

        async function deleteFolder(index) {
            const folder = state.folders[index];
            const projectCount = state.projects.filter(p => p.folder === folder.name).length;
            
            let message = `Delete folder "${folder.name}"?`;
            if (projectCount > 0) {
                message += `\n\nThis will move ${projectCount} project${projectCount !== 1 ? 's' : ''} to Unassigned.`;
            }
            
            if (confirm(message)) {
                state.projects.forEach(project => {
                    if (project.folder === folder.name) project.folder = null;
                });
                
                state.folders.splice(index, 1);
                saveCachedData();
                await saveUserData();
                showToast('Folder deleted!', 'success');
                showFolderManagement();
            }
        }

        // Open Folder
        function openFolder(folderName, authenticated = false) {
            if (folderName === 'Offers' && !authenticated) {
                attemptOpenOffers();
                return;
            }
            
            const folder = folderName === 'Unassigned' 
                ? { name: 'Unassigned', protected: false }
                : state.folders.find(f => f.name === folderName);
            
            if (folder && folder.protected && folder.password && folderName !== 'Offers') {
                state.pendingAction = { type: 'openFolder', folderName };
                document.getElementById('modalTitle').textContent = 'Protected Folder';
                document.getElementById('modalDescription').textContent = 'This folder is password protected. Please enter the password.';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordModal').classList.add('show');
                document.getElementById('passwordInput').focus();
                return;
            }
            
            // Actually navigate to the folder
            state.currentFolder = folderName;
            
            // Hide all views first
            document.getElementById('foldersView').style.display = 'none';
            document.getElementById('folderManagementView').style.display = 'none';
            
            // Show folder content view
            document.getElementById('folderContentView').style.display = 'block';
            document.getElementById('currentFolder').textContent = folderName;
            
            if (folderName === 'Offers') {
                document.getElementById('folderTitle').textContent = 'Offer Templates';
                document.querySelector('.quick-deploy').style.display = 'none';
                document.getElementById('bulkDeleteBtn').style.display = 'none';
                document.getElementById('refreshBtn').style.display = 'none';
                
                showOffers();
            } else {
                document.getElementById('folderTitle').textContent = `${folderName} Projects`;
                document.querySelector('.quick-deploy').style.display = 'block';
                document.getElementById('bulkDeleteBtn').style.display = 'flex';
                document.getElementById('refreshBtn').style.display = 'flex';
                
                loadProjects();
            }
        }

        // Projects
        function loadProjects() {
            if (!state.currentFolder) return;
            
            const grid = document.getElementById('projectsGrid');
            const folderProjects = state.currentFolder === 'Unassigned'
                ? state.projects.filter(p => !p.folder)
                : state.projects.filter(p => p.folder === state.currentFolder);
            
            if (folderProjects.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <h3>No Projects Yet</h3>
                        <p>Click "Deploy Now" to transform your first page</p>
                    </div>`;
                return;
            }
            
            // Sort projects by creation date (newest first)
            const sortedProjects = [...folderProjects].sort((a, b) => {
                const dateA = new Date(a.createdAt || 0);
                const dateB = new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            grid.innerHTML = sortedProjects.map((project, index) => {
                const isActive = project.template && project.template !== 'blank';
                let statusText = '○ Blank';
                let statusClass = 'blank';
                
                if (isActive) {
                    if (project.template === 'customoffer' && project.offerName) {
                        statusText = `✓ ${project.offerName}`;
                    } else {
                        statusText = '✓ Active';
                    }
                    statusClass = 'active';
                }
                
                // Use the actual URL from the project - don't modify it
                const projectUrl = project.actualUrl || project.url || `https://${project.name}.vercel.app`;
                
                // Ensure the URL is clean - no trailing slashes or extra paths
                const cleanProjectUrl = cleanUrl(projectUrl);
                
                // Calculate time ago
                const createdDate = new Date(project.createdAt || Date.now());
                const timeAgo = getTimeAgo(createdDate);
                
                // Check if it's the newest project
                const isNewest = index === 0;
                
                return `
                <div class="project-card ${state.selectedProject && state.selectedProject.id === project.id ? 'selected' : ''} ${isNewest ? 'newest-project' : ''}" onclick="selectProject('${project.id}', event)">
                    ${isNewest ? '<div class="newest-badge">✨ Latest</div>' : ''}
                    <div class="project-header">
                        <div class="project-url">${project.name}</div>
                        <div class="project-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                    <div class="project-url-full">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24" style="opacity: 0.5;">
                            <path d="M24 22.525H0l12-21.05 12 21.05z"/>
                        </svg>
                        ${cleanProjectUrl}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 0.75rem;">
                        Created ${timeAgo}
                    </div>
                    <div class="project-actions">
                        <button class="btn btn-secondary btn-sm" data-url="${cleanProjectUrl}" onclick="copyUrl(event)">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            Copy
                        </button>
                        <a href="${cleanProjectUrl}" target="_blank" class="btn btn-secondary btn-sm" onclick="event.stopPropagation()">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                            Visit
                        </a>
                    </div>
                </div>`;
            }).join('');
            
            updateStats();
            
            // Update template selector if a project is selected
            if (state.selectedProject && document.getElementById('selectedProjectEditor').style.display !== 'none') {
                updateTemplateSelector();
            }
        }

        function selectProject(projectId, event) {
            if (event) event.stopPropagation();
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            state.selectedProject = project;
            state.selectedTemplate = project.template || 'blank';
            state.selectedOffer = null;
            
            loadProjects();
            document.getElementById('selectedProjectEditor').style.display = 'block';
            document.getElementById('editingProjectName').textContent = project.name;
            
            renderTemplateSelector();
            
            // Scroll to editor
            const editor = document.getElementById('selectedProjectEditor');
            if (editor && editor.scrollIntoView) {
                try {
                    editor.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } catch (e) {
                    // Fallback for older browsers
                    editor.scrollIntoView();
                }
            }
        }

        function renderTemplateSelector() {
            const selector = document.getElementById('templateSelector');
            if (!selector) {
                console.error('Template selector element not found');
                return;
            }
            
            selector.innerHTML = '';
            
            // Create title
            const title = document.createElement('h4');
            title.style.marginBottom = '1rem';
            title.textContent = 'Choose Template';
            selector.appendChild(title);
            
            // Create grid container
            const grid = document.createElement('div');
            grid.className = 'template-grid';
            
            // Create blank template option
            const blankOption = document.createElement('div');
            blankOption.className = 'template-option' + (state.selectedTemplate === 'blank' ? ' selected' : '');
            blankOption.innerHTML = `
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <div>Blank Page</div>`;
            
            // Add click handler
            blankOption.onclick = function(e) {
                e.stopPropagation();
                console.log('Blank template clicked');
                selectTemplate('blank');
            };
            
            grid.appendChild(blankOption);
            
            // Filter to only show available offers
            const availableOffers = state.offers.filter(offer => offer.available !== false);
            
            // Create offer template options
            availableOffers.forEach((offer, actualIndex) => {
                // Find the real index in the full offers array
                const realIndex = state.offers.findIndex(o => o === offer);
                
                const offerOption = document.createElement('div');
                offerOption.className = 'template-option' + (state.selectedOffer === realIndex ? ' selected' : '');
                offerOption.innerHTML = `
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M7 7h10l2 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2zM7 3h10a2 2 0 012 2v2H5V5a2 2 0 012-2z"/>
                    </svg>
                    <div>${offer.name}</div>`;
                
                // Add click handler
                offerOption.onclick = function(e) {
                    e.stopPropagation();
                    console.log('Offer template clicked:', realIndex);
                    selectOffer(realIndex);
                };
                
                grid.appendChild(offerOption);
            });
            
            selector.appendChild(grid);
            
            // Add help text if no available offers
            if (availableOffers.length === 0) {
                const helpText = document.createElement('p');
                helpText.style.textAlign = 'center';
                helpText.style.marginTop = '1rem';
                helpText.style.color = 'var(--text-secondary)';
                helpText.style.fontSize = '0.875rem';
                helpText.textContent = 'No templates available';
                selector.appendChild(helpText);
            }
            
            console.log('Template selector rendered with', availableOffers.length, 'available offers');
        }

        function updateTemplateSelector() {
            // Just call the new render function
            renderTemplateSelector();
        }

        function selectTemplate(template) {
            state.selectedTemplate = template;
            state.selectedOffer = null;
            renderTemplateSelector();
        }

        function selectOffer(index) {
            state.selectedTemplate = 'offer';
            state.selectedOffer = index;
            renderTemplateSelector();
        }

        // Quick Deploy
        let pendingDeployFolder = null;
        
        // Note: Project name and production URL can be different!
        // Example: Project name = "lion", Production URL = "lion-peach.vercel.app"
        // We must get the actual production domain from the deployment response
        
        async function quickDeploy() {
            // Generate a random name as default
            const randomName = generateProjectName();
            pendingDeployFolder = state.currentFolder === 'Unassigned' ? null : state.currentFolder;
            
            // Show modal instead of prompt
            document.getElementById('deployNameInput').value = '';
            document.getElementById('deployNameInput').placeholder = `Project name (e.g., ${randomName})`;
            document.getElementById('deployModal').classList.add('show');
            document.getElementById('deployNameInput').focus();
        }
        
        async function confirmDeploy() {
            const input = document.getElementById('deployNameInput').value.trim();
            const randomName = generateProjectName();
            const name = input || randomName;
            
            // Validate name (Vercel requirements: lowercase, alphanumeric, hyphens)
            const validName = name.toLowerCase().replace(/[^a-z0-9-]/g, '');
            
            if (!validName) {
                showToast('Invalid project name', 'error');
                return;
            }
            
            closeModal('deployModal');
            
            // Find the deploy button and update it
            const deployBtns = document.querySelectorAll('.deploy-btn');
            let btn = null;
            deployBtns.forEach(b => {
                if (b.textContent.includes('Deploy Now')) {
                    btn = b;
                }
            });
            
            if (btn) {
                btn.disabled = true;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<div class="spinner"></div> Deploying...';
                
                try {
                    const createBody = {
                        name: validName
                    };
                    
                    const createResponse = await fetch(`https://api.vercel.com/v9/projects${getTeamQuery()}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.vercelToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(createBody)
                    });
                    
                    let actualProjectName = validName;
                    let productionUrl = '';
                    
                    if (!createResponse.ok) {
                        const errorText = await createResponse.text();
                        console.error('Failed to create project:', errorText);
                        
                        // If project name already exists, Vercel might have created it with a different name
                        // Try to parse the error or just generate a completely new random name
                        if (errorText.includes('already exists')) {
                            // Generate a new unique name with timestamp
                            actualProjectName = `${validName}-${Date.now().toString(36)}`;
                            
                            // Try again with the new name
                            const retryBody = {
                                name: actualProjectName
                            };
                            
                            const retryResponse = await fetch(`https://api.vercel.com/v9/projects${getTeamQuery()}`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${state.vercelToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(retryBody)
                            });
                            
                            if (!retryResponse.ok) {
                                throw new Error('Failed to create project with unique name');
                            }
                            
                            const retryData = await retryResponse.json();
                            
                            console.log('=== RETRY PROJECT CREATION RESPONSE ===');
                            console.log(JSON.stringify(retryData, null, 2));
                            console.log('=======================================');
                            
                            // Get the project name
                            actualProjectName = retryData.name || retryData.id || actualProjectName;
                            
                            console.log('>>> Retry - Project created with name:', actualProjectName);
                            
                            // Don't set production URL here - we'll get it from deployment
                            productionUrl = '';
                        } else {
                            throw new Error('Failed to create project');
                        }
                    } else {
                        // Project created successfully
                        const projectData = await createResponse.json();
                        
                        console.log('=== PROJECT CREATION RESPONSE ===');
                        console.log(JSON.stringify(projectData, null, 2));
                        console.log('=================================');
                        
                        // Get the project name and ID
                        actualProjectName = projectData.name || validName;
                        const projectId = projectData.id;
                        
                        console.log('>>> Project name:', actualProjectName);
                        console.log('>>> Project ID:', projectId);
                        
                        // IMPORTANT: The project name might be "lion" but the domain might be "lion-neon.vercel.app"
                        // We need to check if Vercel assigned a production domain
                        
                        // Check if the response includes domain information
                        if (projectData.alias && Array.isArray(projectData.alias)) {
                            console.log('>>> Project aliases in creation response:', projectData.alias);
                            
                            // Look for .vercel.app domain
                            const vercelDomain = projectData.alias.find(a => 
                                (typeof a === 'string' && a.endsWith('.vercel.app')) ||
                                (a.domain && a.domain.endsWith('.vercel.app'))
                            );
                            
                            if (vercelDomain) {
                                const domain = typeof vercelDomain === 'string' ? vercelDomain : vercelDomain.domain;
                                productionUrl = `https://${domain}`;
                                console.log('>>> Found production domain in creation response:', productionUrl);
                            }
                        }
                        
                        // Check link.domain field
                        if (!productionUrl && projectData.link && projectData.link.domain) {
                            productionUrl = `https://${projectData.link.domain}`;
                            console.log('>>> Found in link.domain:', productionUrl);
                        }
                        
                        // We'll determine the final URL after deployment if not found here
                        if (!productionUrl) {
                            console.log('>>> Production URL will be determined after deployment');
                        }
                    }
                    
                    // Now deploy to the created project
                    const deploymentData = {
                        name: actualProjectName,
                        files: [{ file: 'index.html', data: '' }],
                        target: 'production',
                        public: true
                    };
                    
                    const response = await fetch(`https://api.vercel.com/v13/deployments${getTeamQuery()}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.vercelToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(deploymentData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('Deployment error:', errorData);
                        throw new Error('Failed to deploy');
                    }
                    
                    const deploymentResult = await response.json();
                    console.log('Deployment created with ID:', deploymentResult.id);
                    
                    // If we don't have production URL yet, we need to get it
                    if (!productionUrl) {
                        // Wait a bit for Vercel to process
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        
                        try {
                            // Fetch the project details to get the assigned production domain
                            const projectResponse = await fetch(
                                `https://api.vercel.com/v9/projects/${actualProjectName}${getTeamQuery()}`,
                                { headers: { 'Authorization': `Bearer ${state.vercelToken}` } }
                            );
                            
                            if (projectResponse.ok) {
                                const project = await projectResponse.json();
                                console.log('=== FETCHING PROJECT FOR PRODUCTION DOMAIN ===');
                                
                                // Check all possible locations for the production domain
                                
                                // 1. Check alias array
                                if (project.alias && Array.isArray(project.alias)) {
                                    console.log('Project aliases:', project.alias);
                                    
                                    project.alias.forEach(alias => {
                                        if (alias.domain && alias.domain.endsWith('.vercel.app')) {
                                            // The production domain should NOT include team name
                                            if (!alias.domain.includes('-blvck') && 
                                                !alias.domain.includes(state.teamName)) {
                                                productionUrl = `https://${alias.domain}`;
                                                console.log('>>> Found production domain:', productionUrl);
                                            }
                                        }
                                    });
                                }
                                
                                // 2. Check link object
                                if (!productionUrl && project.link) {
                                    console.log('Project link:', project.link);
                                    
                                    if (project.link.domain && project.link.domain.endsWith('.vercel.app')) {
                                        productionUrl = `https://${project.link.domain}`;
                                        console.log('>>> Found in link.domain:', productionUrl);
                                    }
                                }
                                
                                // 3. Check domains array  
                                if (!productionUrl && project.domains && Array.isArray(project.domains)) {
                                    console.log('Project domains:', project.domains);
                                    
                                    const vercelDomain = project.domains.find(d => 
                                        d.endsWith('.vercel.app') && !d.includes('-blvck')
                                    );
                                    
                                    if (vercelDomain) {
                                        productionUrl = `https://${vercelDomain}`;
                                        console.log('>>> Found in domains array:', productionUrl);
                                    }
                                }
                                
                                // 4. Check targets.production
                                if (!productionUrl && project.targets && project.targets.production) {
                                    console.log('Production target:', project.targets.production);
                                    
                                    if (project.targets.production.alias && 
                                        Array.isArray(project.targets.production.alias)) {
                                        
                                        const prodAlias = project.targets.production.alias.find(a => 
                                            a.endsWith('.vercel.app') && !a.includes('-blvck')
                                        );
                                        
                                        if (prodAlias) {
                                            productionUrl = `https://${prodAlias}`;
                                            console.log('>>> Found in production target:', productionUrl);
                                        }
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching project for domain:', error);
                        }
                    }
                    
                    // Final fallback - use project name
                    if (!productionUrl) {
                        productionUrl = `https://${actualProjectName}.vercel.app`;
                        console.log('>>> Using project name as fallback:', productionUrl);
                    }
                    
                    console.log('\n*** FINAL PRODUCTION URL:', productionUrl, '***\n');
                    
                    // Wait for deployment to propagate
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Wait a bit for deployment to be ready
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const newProject = {
                        id: Date.now().toString(),
                        name: actualProjectName,
                        url: cleanUrl(productionUrl),
                        actualUrl: cleanUrl(productionUrl),
                        template: 'blank',
                        folder: pendingDeployFolder,
                        createdAt: new Date().toISOString()
                    };
                    
                    state.projects.unshift(newProject);
                    saveCachedData();
                    await saveUserData();
                    
                    showToast(`Deployed! ${cleanUrl(productionUrl)}`, 'success');
                    
                    loadProjects();
                    
                } catch (error) {
                    showToast(error.message || 'Failed to deploy project', 'error');
                    console.error('Deployment error:', error);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
        }

        async function updateProject() {
            if (!state.selectedProject) return;
            
            const btn = event.target.closest('button');
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Deploying...';
            
            try {
                let content = '';
                let templateType = state.selectedTemplate;
                let offerName = null;
                
                if (state.selectedTemplate === 'offer' && state.selectedOffer !== null) {
                    content = state.offers[state.selectedOffer].html;
                    templateType = 'customoffer';
                    offerName = state.offers[state.selectedOffer].name;
                }
                
                const deploymentData = {
                    name: state.selectedProject.name,
                    files: [{ file: 'index.html', data: content }],
                    target: 'production',
                    public: true
                };
                
                const response = await fetch(`https://api.vercel.com/v13/deployments${getTeamQuery()}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.vercelToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deploymentData)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('Deployment error:', errorData);
                    throw new Error('Failed to deploy');
                }
                
                // Don't change the URL - keep the original production URL
                const projectIndex = state.projects.findIndex(p => p.id === state.selectedProject.id);
                if (projectIndex >= 0) {
                    state.projects[projectIndex].template = templateType;
                    state.projects[projectIndex].offerName = offerName;
                    // Keep the existing URLs unchanged
                    saveCachedData();
                    await saveUserData();
                }
                
                showToast('Project updated successfully!', 'success');
                loadProjects();
                
            } catch (error) {
                showToast('Failed to update project', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        async function deleteProject() {
            if (!state.selectedProject || !confirm(`Delete ${state.selectedProject.name}?`)) return;
            
            const btn = event.target.closest('button');
            btn.disabled = true;
            
            try {
                const response = await fetch(`https://api.vercel.com/v9/projects/${state.selectedProject.name}${getTeamQuery()}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${state.vercelToken}` }
                });
                
                if (!response.ok) {
                    console.error('Failed to delete project from Vercel');
                }
                
                const index = state.projects.findIndex(p => p.id === state.selectedProject.id);
                if (index >= 0) {
                    state.projects.splice(index, 1);
                    saveCachedData();
                    await saveUserData();
                }
                
                showToast('Project deleted', 'success');
                state.selectedProject = null;
                document.getElementById('selectedProjectEditor').style.display = 'none';
                loadProjects();
                
            } catch (error) {
                showToast('Failed to delete project', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function bulkDeleteFolder() {
            const folderProjects = state.currentFolder === 'Unassigned'
                ? state.projects.filter(p => !p.folder)
                : state.projects.filter(p => p.folder === state.currentFolder);
            
            if (folderProjects.length === 0) {
                showToast('No projects in this folder', 'warning');
                return;
            }
            
            if (!confirm(`Delete all ${folderProjects.length} projects in ${state.currentFolder}?`)) return;
            
            const btn = event.target.closest('button');
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Deleting...';
            
            let deletedCount = 0;
            
            for (const project of folderProjects) {
                try {
                    await fetch(`https://api.vercel.com/v9/projects/${project.name}${getTeamQuery()}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${state.vercelToken}` }
                    });
                    deletedCount++;
                } catch (error) {
                    // Continue
                }
            }
            
            if (state.currentFolder === 'Unassigned') {
                state.projects = state.projects.filter(p => p.folder);
            } else {
                state.projects = state.projects.filter(p => p.folder !== state.currentFolder);
            }
            
            saveCachedData();
            await saveUserData();
            showToast(`Deleted ${deletedCount} projects`, 'success');
            loadProjects();
            
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }

        async function refreshFromVercel() {
            const btn = event.target.closest('button');
            btn.disabled = true;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Syncing...';
            
            // Update status indicator
            const statusIndicator = document.getElementById('statusIndicator');
            const connectionStatus = document.getElementById('connectionStatus');
            statusIndicator.style.background = 'var(--warning)';
            statusIndicator.style.boxShadow = '0 0 20px var(--warning-glow)';
            connectionStatus.textContent = 'Syncing with Vercel...';
            
            try {
                // Save current state to Vercel
                await saveUserData();
                
                // Wait a moment for deployment
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Reload all data from Vercel data project
                const loaded = await loadUserData();
                
                if (!loaded) {
                    // If couldn't load from Vercel, at least we have cache
                    showToast('Using cached data', 'warning');
                } else {
                    showToast('All data synced successfully', 'success');
                }
                
                // Update cache
                saveCachedData();
                
                // Reload the current view
                if (state.currentFolder === 'Offers') {
                    showOffers();
                } else {
                    loadProjects();
                }
                updateStats();
                
            } catch (error) {
                console.error('Error syncing data:', error);
                showToast('Sync failed, using cached data', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                
                // Restore status indicator
                statusIndicator.style.background = 'var(--success)';
                statusIndicator.style.boxShadow = '0 0 20px var(--success-glow)';
                connectionStatus.textContent = 'Connected to Vercel';
            }
        }

        // Offers
        function showOffers() {
            const grid = document.getElementById('projectsGrid');
            
            if (state.offers.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M7 7h10l2 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2zM7 3h10a2 2 0 012 2v2H5V5a2 2 0 012-2z"/>
                        </svg>
                        <h3>No Templates Yet</h3>
                        <p>Create your first offer template to reuse across projects</p>
                        <button class="btn" onclick="window.createNewOffer()" style="display: inline-flex !important; width: auto !important; margin: 0 auto;">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 4v16m8-8H4"/>
                            </svg>
                            Create Template
                        </button>
                    </div>`;
            } else {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>Saved Templates</h3>
                            <button class="btn" onclick="createNewOffer()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 4v16m8-8H4"/>
                                </svg>
                                New Template
                            </button>
                        </div>
                        <div class="management-grid">
                            ${state.offers.map((offer, index) => {
                                const isAvailable = offer.available !== false;
                                
                                return `
                                <div class="management-card ${!isAvailable ? 'hidden' : ''}">
                                    <div class="management-card-header">
                                        <div>
                                            <div class="management-card-badges">
                                                <div class="project-status active">Template</div>
                                                ${!isAvailable ? '<div class="folder-badge" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger);">Hidden</div>' : ''}
                                            </div>
                                        </div>
                                        <button class="visibility-toggle ${isAvailable ? 'visible' : 'hidden'}" onclick="event.stopPropagation(); toggleOfferAvailability(${index})" title="${isAvailable ? 'Hide template' : 'Show template'}">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                ${isAvailable ? 
                                                    '<path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>' :
                                                    '<path d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>'
                                                }
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="management-card-content">
                                        <div class="management-card-icon">
                                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M7 7h10l2 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2zM7 3h10a2 2 0 012 2v2H5V5a2 2 0 012-2z"/>
                                            </svg>
                                        </div>
                                        <div class="management-card-name">${offer.name}</div>
                                        <div class="management-card-count">
                                            Created ${new Date(offer.createdAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    <div class="management-card-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="editOffer(${index})">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                            Edit
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteOffer(${index})">
                                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }
        }

        async function toggleOfferAvailability(index) {
            const offer = state.offers[index];
            offer.available = offer.available === false ? true : false;
            
            saveCachedData();
            await saveUserData();
            showToast(offer.available ? 'Template is now visible' : 'Template is now hidden', 'success');
            showOffers();
        }

        function createNewOffer() {
            state.editingOfferIndex = null;
            document.getElementById('offerModalTitle').textContent = 'Create Offer Template';
            document.getElementById('offerName').value = '';
            document.getElementById('offerHtml').value = '';
            document.getElementById('offerModal').classList.add('show');
            document.getElementById('offerName').focus();
        }

        function editOffer(index) {
            state.editingOfferIndex = index;
            const offer = state.offers[index];
            document.getElementById('offerModalTitle').textContent = 'Edit Offer Template';
            document.getElementById('offerName').value = offer.name;
            document.getElementById('offerHtml').value = offer.html;
            document.getElementById('offerModal').classList.add('show');
            document.getElementById('offerName').focus();
        }

        async function saveOffer() {
            const name = document.getElementById('offerName').value.trim();
            const html = document.getElementById('offerHtml').value.trim();
            
            if (!name || !html) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            const offerData = {
                name,
                html,
                type: 'Custom Offer',
                createdAt: new Date().toISOString(),
                available: true // New offers are available by default
            };
            
            if (state.editingOfferIndex !== null) {
                // Preserve existing availability state when editing
                offerData.available = state.offers[state.editingOfferIndex].available !== false;
                state.offers[state.editingOfferIndex] = { ...state.offers[state.editingOfferIndex], ...offerData };
                showToast('Template updated!', 'success');
            } else {
                state.offers.push(offerData);
                showToast('Template created!', 'success');
            }
            
            saveCachedData();
            await saveUserData();
            closeModal('offerModal');
            showOffers();
        }

        async function deleteOffer(index) {
            if (confirm(`Delete template "${state.offers[index].name}"?`)) {
                state.offers.splice(index, 1);
                saveCachedData();
                await saveUserData();
                showToast('Template deleted!', 'success');
                showOffers();
            }
        }

        // Utilities
        function cleanUrl(url) {
            if (!url) return '';
            
            // Remove any protocol if present
            let cleaned = url.replace(/^https?:\/\//, '');
            
            // Remove any path, query parameters, or fragments
            cleaned = cleaned.split('/')[0];
            cleaned = cleaned.split('?')[0];
            cleaned = cleaned.split('#')[0];
            
            // Remove trailing dots or slashes
            cleaned = cleaned.replace(/[.\/]+$/, '');
            
            // Add https:// back if it was removed
            if (!cleaned.startsWith('http://') && !cleaned.startsWith('https://')) {
                cleaned = `https://${cleaned}`;
            }
            
            return cleaned;
        }
        
        function generateProjectName() {
            // Components for creating unique combinations
            const prefixes = ['x', 'z', 'q', 'j', 'v', 'w', 'y', 'k'];
            const vowels = ['a', 'e', 'i', 'o', 'u', 'y'];
            const consonants = ['b', 'c', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'm', 'n', 'p', 'q', 'r', 's', 't', 'v', 'w', 'x', 'z'];
            const endings = ['ix', 'ax', 'ox', 'ux', 'ex', 'yx', 'az', 'ez', 'iz', 'oz', 'uz', 'yz'];
            
            // Generate a truly unique name using timestamp + random components
            const timestamp = Date.now().toString(36); // Base36 timestamp
            const randomPart = Math.random().toString(36).substring(2, 5); // 3 random chars
            
            // Create patterns
            const patterns = [
                () => {
                    // Pattern 1: prefix + timestamp + ending
                    const pre = prefixes[Math.floor(Math.random() * prefixes.length)];
                    const end = endings[Math.floor(Math.random() * endings.length)];
                    return `${pre}${timestamp}${end}`;
                },
                () => {
                    // Pattern 2: consonant + vowel + timestamp
                    const c = consonants[Math.floor(Math.random() * consonants.length)];
                    const v = vowels[Math.floor(Math.random() * vowels.length)];
                    return `${c}${v}${timestamp}`;
                },
                () => {
                    // Pattern 3: timestamp + random + ending
                    const end = endings[Math.floor(Math.random() * endings.length)];
                    return `${timestamp}${randomPart}${end}`;
                },
                () => {
                    // Pattern 4: random syllable + timestamp
                    const c1 = consonants[Math.floor(Math.random() * consonants.length)];
                    const v1 = vowels[Math.floor(Math.random() * vowels.length)];
                    const c2 = consonants[Math.floor(Math.random() * consonants.length)];
                    return `${c1}${v1}${c2}${timestamp}`;
                },
                () => {
                    // Pattern 5: unique combo with counter
                    const uniqueId = `${timestamp}${performance.now().toString(36).replace('.', '')}`;
                    return uniqueId.substring(0, 12);
                }
            ];
            
            // Select random pattern
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            let name = pattern();
            
            // Ensure it starts with a letter (Vercel requirement)
            if (!/^[a-z]/.test(name)) {
                const letter = consonants[Math.floor(Math.random() * consonants.length)];
                name = letter + name;
            }
            
            // Clean and trim to reasonable length (3-15 chars)
            name = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            if (name.length > 15) {
                name = name.substring(0, 15);
            }
            if (name.length < 3) {
                name = name + randomPart;
            }
            
            return name;
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
            if (seconds < 2592000) return `${Math.floor(seconds / 604800)} weeks ago`;
            if (seconds < 31536000) return `${Math.floor(seconds / 2592000)} months ago`;
            return `${Math.floor(seconds / 31536000)} years ago`;
        }

        function copyUrl(event) {
            event.stopPropagation();
            const button = event.currentTarget;
            const url = button.getAttribute('data-url');
            
            navigator.clipboard.writeText(url).then(() => {
                const originalContent = button.innerHTML;
                button.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg> Copied';
                button.style.color = 'var(--success)';
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy URL:', err);
                showToast('Failed to copy URL', 'error');
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            toast.className = `toast show ${type}`;
            toastMessage.textContent = message;
            
            const icons = {
                success: '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                error: '<path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                warning: '<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>'
            };
            
            toastIcon.innerHTML = icons[type] || icons.success;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            state.pendingAction = null;
            state.editingFolderIndex = null;
            state.editingOfferIndex = null;
        }

        // Event Listeners
        document.getElementById('folderProtected').addEventListener('change', function(e) {
            document.getElementById('folderPasswordInput').style.display = e.target.checked ? 'block' : 'none';
        });

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });

        // Improved auto-submit without delay
        document.getElementById('passwordInput').addEventListener('input', function(e) {
            const password = e.target.value;
            
            // Check immediately if it matches admin password
            if (password === state.adminPassword) {
                checkPassword();
            } else if (state.pendingAction?.type === 'openFolder') {
                // For folder passwords, check against the specific folder
                const folder = state.folders.find(f => f.name === state.pendingAction.folderName);
                if (folder && password === folder.password) {
                    checkPassword();
                }
            }
        });

        document.getElementById('folderNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('folderProtected').checked) {
                    document.getElementById('folderPasswordInput').focus();
                } else {
                    saveFolderSettings();
                }
            }
        });

        document.getElementById('folderPasswordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') saveFolderSettings();
        });

        document.getElementById('offerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('offerHtml').focus();
            }
        });

        document.getElementById('deployNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') confirmDeploy();
        });

        document.getElementById('vercelToken').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') saveToken();
        });

        // Click outside to close modals with proper cleanup
        document.querySelectorAll('.modal').forEach(modal => {
            const listener = function(e) {
                if (e.target === this) closeModal(this.id);
            };
            modal.addEventListener('click', listener);
            modalClickListeners.push({ element: modal, listener });
        });

        // Save cache before page unload
        window.addEventListener('beforeunload', () => {
            saveCachedData();
        });

        // Cleanup function
        function cleanup() {
            // Remove modal listeners
            modalClickListeners.forEach(({ element, listener }) => {
                element.removeEventListener('click', listener);
            });
            modalClickListeners = [];
        }

        // Override data project (for recovery in private mode)
        async function overrideDataProject() {
            const override = document.getElementById('dataProjectOverride').value.trim();
            
            if (!override) {
                showToast('Please enter a data project name', 'error');
                return;
            }
            
            // Save the override
            state.dataProjectName = override;
            state.dataProjectUrl = `https://${override}.vercel.app`;
            localStorage.setItem('userDataProjectName', override);
            localStorage.setItem('userDataProjectUrl', state.dataProjectUrl);
            
            showToast('Loading data from specified project...', 'success');
            
            // Reload the app with the new data project
            await init();
        }

        // Make functions globally available
        window.selectTemplate = selectTemplate;
        window.selectOffer = selectOffer;
        window.selectProject = selectProject;
        window.copyUrl = copyUrl;
        window.openFolder = openFolder;
        window.showFoldersView = showFoldersView;
        window.attemptManageFolders = attemptManageFolders;
        window.attemptOpenOffers = attemptOpenOffers;
        window.refreshFromVercel = refreshFromVercel;
        window.quickDeploy = quickDeploy;
        window.confirmDeploy = confirmDeploy;
        window.updateProject = updateProject;
        window.deleteProject = deleteProject;
        window.bulkDeleteFolder = bulkDeleteFolder;
        window.createNewFolder = createNewFolder;
        window.editFolder = editFolder;
        window.deleteFolder = deleteFolder;
        window.saveFolderSettings = saveFolderSettings;
        window.toggleFolderAvailability = toggleFolderAvailability;
        window.toggleOfferAvailability = toggleOfferAvailability;
        window.closeModal = closeModal;
        window.checkPassword = checkPassword;
        window.createNewOffer = createNewOffer;
        window.editOffer = editOffer;
        window.deleteOffer = deleteOffer;
        window.saveOffer = saveOffer;
        window.saveToken = saveToken;
        window.overrideDataProject = overrideDataProject;

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
